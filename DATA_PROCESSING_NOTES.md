# 資料處理說明 - 無效值處理

## 無效值過濾邏輯

### 1. 客觀財富（收入變數）

所有年份的收入變數使用統一的過濾邏輯：

```python
def convert_income_code_to_monthly(code, year):
    if pd.isna(code) or code >= 90:
        return None
    # ... 其他處理
```

**過濾的編碼值** (code >= 90):
- 96: 跳答
- 97: 不知道
- 98: 拒答
- 99: 遺漏值/跳答/不適用

### 2. 主觀財富（階級認同）

使用標籤關鍵字過濾：

```python
def get_subjective_class(row, year, meta):
    # ... 取得標籤
    if label and any(x in label for x in ['不知道', '拒答', '跳答', '漏答', '無意見', '無反應']):
        return None
    # ... 其他處理
```

**各年度的無效值標籤**:

- **1992 年 (v65a)**: 無明確的無效值標籤
- **1997 年 (v89a)**: 
  - 97: 不知道
  - 99: 跳答
- **2002 年 (v126)**:
  - 94: 無意見
  - 96: 漏答
  - 97: 不知道
  - 98: 拒答
  - 99: 跳答或不適用
- **2007 年 (f5)**:
  - 96: 漏答
  - 97: 不知道,無法選擇
  - 98: 拒答
  - 99: 遺漏值或跳答
- **2012 年 (v94)**:
  - 97: 不知道
  - 98: 拒答
- **2017 年 (e2)**:
  - 96: 跳答
  - 97: 不知道
  - 98: 拒答
  - 99: 遺漏值
- **2022 年 (e2)**:
  - 97: 不知道
  - 98: 拒答

### 3. 快樂程度（滿意度）

使用數值過濾：

```python
def get_happiness(row, year, meta):
    # ... 取得數值
    if value >= 90:
        return None
    # ... 其他處理
```

**過濾邏輯**: value >= 90 (通常 95-99 為無效值)

## 特殊處理規則

### 1992 年家庭主婦排除

```python
def should_exclude_1992_housewife(row, annual_income):
    gender = row.get('v1', np.nan)
    # 女性 (gender=2) 且年收入 < 117,876 元
    if not pd.isna(gender) and gender == 2:
        if not pd.isna(annual_income) and annual_income < 117876:
            return True
    return False
```

### 2002 年勞工階級判定

```python
# 如果 v126 = "中下層" 且 v125 = "工與農民階級"
if '中下' in v126_label and ('工' in v125_label or '農民' in v125_label):
    return '勞工階級'
```

## 資料完整性

最終保留的樣本數（需同時具備主觀和客觀財富資料）:

| 年份 | 總樣本 | 有效樣本 | 保留率 |
|------|--------|----------|--------|
| 1992 | 2377   | 1642     | 69.1%  |
| 1997 | 2596   | 2390     | 92.1%  |
| 2002 | 1992   | 1616     | 81.1%  |
| 2007 | 2040   | 1867     | 91.5%  |
| 2012 | 2134   | 1443     | 67.6%  |
| 2017 | 1917   | 1338     | 69.8%  |
| 2022 | 1739   | 1372     | 78.9%  |

**總計**: 14,795 → 12,668 (85.6% 保留率)

## 資料品質檢查清單

- [x] 客觀財富: 所有 code >= 90 的值已過濾
- [x] 主觀財富: 所有無效標籤已過濾
- [x] 快樂程度: 所有 value >= 90 的值已過濾
- [x] 1992 年家庭主婦已排除
- [x] 2002 年勞工階級邏輯已實作
- [x] 所有年份都有 5 個客觀財富等級
- [x] 所有年份都有 6 個主觀財富等級

---

**最後更新**: 2025-12-11
**腳本版本**: prepare_wealth_data.py v2
